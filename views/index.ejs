<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizzazione file</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header>
    <h1>Viaualizzazione performance Nodi</h1>
    <nav>
      <a href="/admin">Area Admin</a>
      <a href="/report/celle" class="link-report">Report Analysis</a>
    </nav>
  </header>

  <main class="dashboard-grid">
    <section class="panel">
      <h2>Filtra per file</h2>
      <form class="filters" action="/" method="get">
        <div class="row">
          <label>
            <span>File</span>
            <select name="file">
              <% (fileOptions || []).forEach(f => { %>
                <option value="<%= f %>" <%= selectedFile === f ? 'selected' : '' %>><%= f %></option>
              <% }) %>
            </select>
          </label>
          <button class="btn" type="submit">Applica</button>
        </div>
      </form>
    </section>
    
    <section class="panel">
      <h2>UL/DL fuori norma</h2>
      <% if (!perfRows || perfRows.length === 0) { %>
        <p>Nessun dato trovato nella sezione sdir_link_performance_wl dei log caricati.</p>
      <% } else { %>
        <div class="table-scroll">
          <table class="table table-fit table-transposed sticky-header sticky-first-col table-wl">
            <tbody>
              <tr>
                <th>Radio</th>
                <% perfRows.forEach(r => { %>
                  <td title="<%= r.RiL %>"><%= r.RiL %></td>
                <% }) %>
              </tr>
              <tr>
                <th>Porte → Celle</th>
                <% perfRows.forEach(r => { %>
                  <td>
                    <% 
                      const bucket = [r.TT, r.WL1, r.WL2, r.LINK].map(v => String(v || '')).join(' ');
                      const tokens = bucket.match(/CS0(?:AE|AN|AM|AT|FM|FT)\d+/g) || [];
                      const ae = tokens.filter(t => t.startsWith('CS0AE'));
                      const an = tokens.filter(t => t.startsWith('CS0AN'));
                      const fm = tokens.filter(t => t.startsWith('CS0FM'));
                      const ft = tokens.filter(t => t.startsWith('CS0FT'));
                      const am = tokens.filter(t => t.startsWith('CS0AM'));
                      const at = tokens.filter(t => t.startsWith('CS0AT'));
                      let ab = '';
                      let cd = '';
                      if (ae.length || an.length) {
                        ab = (ae[0] || '') + ((ae[0] && an[0]) ? '/' : '') + (an[0] || '');
                        cd = (ae[1] || '') + ((ae[1] && an[1]) ? '/' : '') + (an[1] || '');
                      } else if (fm.length || ft.length) {
                        ab = (fm[0] || '') + ((fm[0] && ft[0]) ? '/' : '') + (ft[0] || '');
                        cd = (fm[1] || '') + ((fm[1] && ft[1]) ? '/' : '') + (ft[1] || '');
                      } else if (am.length || at.length) {
                        ab = (am[0] || '') + ((am[0] && at[0]) ? '/' : '') + (at[0] || '');
                        cd = (am[1] || '') + ((am[1] && at[1]) ? '/' : '') + (at[1] || '');
                      }
                      // Fallback: se nessun token è presente, prova a derivare da RiL per file CS0AT*
                      if (!ab && !cd) {
                        const rilStr = String(r.RiL || '');
                        const m = rilStr.match(/(?:Radio-)?S(\d+)-(\d+)/i);
                        if (m && /AT/i.test(String(r.source || ''))) {
                          const n = m[1];
                          ab = `CS0AE${n}/CS0AN${n}`;
                        }
                      }
                    %>
                    <% if (ab || cd) { %>
                      <span class="badge badge-ok">AB</span> <span class="mono" title="<%= ab %>"><%= ab %></span><% if (cd) { %> · <span class="badge badge-ok">CD</span> <span class="mono" title="<%= cd %>"><%= cd %></span><% } %>
                    <% } else { %>
                      N/D
                    <% } %>
                  </td>
                <% }) %>
              </tr>
              <tr>
                <th>DlLoss</th>
                <% perfRows.forEach(r => { %>
                  <% const mDl = String(r.DlLoss || '').match(/^[\s]*([+-]?[0-9]+(?:[.,][0-9]+)?)/); const vDl = mDl ? parseFloat(mDl[1].replace(',', '.')) : NaN; const badDl = (!Number.isNaN(vDl) && vDl < -3.49); %>
                  <td class="<%= badDl ? 'cell-danger' : '' %>" title="<%= r.DlLoss %>"><span class="num <%= badDl ? 'badge badge-danger' : '' %>"><%= r.DlLoss %></span></td>
                <% }) %>
              </tr>
              <tr>
                <th>UlLoss</th>
                <% perfRows.forEach(r => { %>
                  <% const mUl = String(r.UlLoss || '').match(/^[\s]*([+-]?[0-9]+(?:[.,][0-9]+)?)/); const vUl = mUl ? parseFloat(mUl[1].replace(',', '.')) : NaN; const badUl = (!Number.isNaN(vUl) && vUl < -3.49); %>
                  <td class="<%= badUl ? 'cell-danger' : '' %>" title="<%= r.UlLoss %>"><span class="num <%= badUl ? 'badge badge-danger' : '' %>"><%= r.UlLoss %></span></td>
                <% }) %>
              </tr>
              <tr>
                <th>LENGTH</th>
                <% perfRows.forEach(r => { %>
                  <td title="<%= r.LENGTH %>"><span class="mono"><%= r.LENGTH %></span></td>
                <% }) %>
              </tr>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>

    <section class="panel">
      <h2>Attenuazione trasporto</h2>
      <% if (!boardRows || boardRows.length === 0) { %>
        <p>Nessun dato trovato nella sezione sdir_board_sfp_metriche dei log caricati.</p>
      <% } else { %>
        <div class="table-scroll">
          <table class="table table-fit table-transposed sticky-header sticky-first-col table-board">
            <tbody>
              <tr>
                <th>ID</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.ID %>"><%= r.ID %></td>
                <% }) %>
              </tr>
              <tr>
                <th>VENDORPROD</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.VENDORPROD %>"><%= r.VENDORPROD %></td>
                <% }) %>
              </tr>
              <tr>
                <th>REV</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.REV %>"><%= r.REV %></td>
                <% }) %>
              </tr>
              <tr>
                <th>SERIAL</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.SERIAL %>"><%= r.SERIAL %></td>
                <% }) %>
              </tr>
              <tr>
                <th>TEMP</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.TEMP %>"><span class="num"><%= r.TEMP %></span></td>
                <% }) %>
              </tr>
              <tr>
                <th>TXbs</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.TXbs %>"><span class="mono"><%= r.TXbs %></span></td>
                <% }) %>
              </tr>
              <tr>
                <th>TXdBm</th>
                <% boardRows.forEach(r => { %>
                  <% const mTx = String(r.TXdBm || '').match(/^[\s]*([+-]?[0-9]+(?:[.,][0-9]+)?)/); const vTx = mTx ? parseFloat(mTx[1].replace(',', '.')) : NaN; const badTx = (!Number.isNaN(vTx) && vTx < -13.99); %>
                  <td class="<%= badTx ? 'cell-danger' : '' %>" title="<%= r.TXdBm %>"><span class="num <%= badTx ? 'badge badge-danger' : '' %>"><%= r.TXdBm %></span></td>
                <% }) %>
              </tr>
              <tr>
                <th>RXdBm</th>
                <% boardRows.forEach(r => { %>
                  <% const mRx = String(r.RXdBm || '').match(/^[\s]*([+-]?[0-9]+(?:[.,][0-9]+)?)/); const vRx = mRx ? parseFloat(mRx[1].replace(',', '.')) : NaN; const badRx = (!Number.isNaN(vRx) && vRx < -13.99); %>
                  <td class="<%= badRx ? 'cell-danger' : '' %>" title="<%= r.RXdBm %>"><span class="num <%= badRx ? 'badge badge-danger' : '' %>"><%= r.RXdBm %></span></td>
                <% }) %>
              </tr>
              <tr>
                <th>BER</th>
                <% boardRows.forEach(r => { %>
                  <td title="<%= r.BER %>"><span class="num"><%= r.BER %></span></td>
                <% }) %>
              </tr>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>

    <section class="panel">
      <h2>VSWR Elevato</h2>
      <% if (!fruRows || fruRows.length === 0) { %>
        <p>Nessun dato trovato nella sezione sdir_fru_radio_metriche dei log caricati.</p>
      <% } else { %>
        <div class="table-scroll">
          <table class="table table-fit table-transposed sticky-header sticky-first-col table-vswr">
            <tbody>
              <tr>
                <th>Radio</th>
                <% fruRows.forEach(r => { %>
                  <td title="<%= r.FRU %>"><%= r.FRU %></td>
                <% }) %>
              </tr>
              <tr>
                <th>BOARD</th>
                <% fruRows.forEach(r => { %>
                  <td title="<%= r.BOARD %>"><%= r.BOARD %></td>
                <% }) %>
              </tr>
              <tr>
                <th>RF</th>
                <% fruRows.forEach(r => { %>
                  <td title="<%= r.RF %>"><%= r.RF %></td>
                <% }) %>
              </tr>
              <tr>
                <th>Cella di riferimento</th>
                <% fruRows.forEach(r => { %>
                  <td>
                    <% 
                      const sc = String(r.SectorCells || '');
                      let refCell = '';
                      const mFdd = sc.match(/FDD\s*=\s*(CS\d+[A-Z]{1,2}\d+)/i);
                      if (mFdd) {
                        refCell = mFdd[1];
                      } else {
                        const mAny = sc.match(/CS\d+[A-Z]{1,2}\d+/g);
                        if (mAny && mAny.length) refCell = mAny[0];
                      }
                    %>
                    <span class="mono" title="<%= refCell || 'N/D' %>"><%= refCell || 'N/D' %></span>
                  </td>
                <% }) %>
              </tr>
              <tr>
                <th>VSWR (RL)</th>
                <% fruRows.forEach(r => { %>
                  <td title="<%= r.VSWR %>"><span class="num <%= r.highVSWR ? 'badge badge-danger' : '' %>"><%= r.VSWR %></span></td>
                <% }) %>
              </tr>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>
  </main>
  <section class="panel">
    <h2>mfar</h2>
    <% if (!mfarRows || mfarRows.length === 0) { %>
      <p>Nessun dato trovato nella sezione mfar dei log caricati.</p>
    <% } else { %>
      <div class="table-scroll">
        <table class="table table-fit table-transposed sticky-header sticky-first-col table-mfar">
          <tbody>
            <tr>
              <th>Cell</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.SC %>"><%= r.SC %></td>
              <% }) %>
            </tr>
            <tr>
              <th>Radio</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.SE %>"><%= r.SE %></td>
              <% }) %>
            </tr>
            <tr>
              <th>Tx/Rx</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.TxRx %>"><%= r.TxRx %></td>
              <% }) %>
            </tr>
            <tr>
              <th>BrPair</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.BrPair %>"><%= r.BrPair %></td>
              <% }) %>
            </tr>
            <tr>
              <th>RfPort1</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.RfPort1 %>"><%= r.RfPort1 %></td>
              <% }) %>
            </tr>
            <tr>
              <th>RfPort2</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.RfPort2 %>"><%= r.RfPort2 %></td>
              <% }) %>
            </tr>
            <tr>
              <th>HW</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.HW %>"><%= r.HW %></td>
              <% }) %>
            </tr>
            <tr>
              <th>Serial</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.Serial %>"><%= r.Serial %></td>
              <% }) %>
            </tr>
            
            <tr>
              <th>Med</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.Med %>"><span class="num"><%= r.Med %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>Mean</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.Mean %>"><span class="num"><%= r.Mean %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>SDev</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.SDev %>"><span class="num"><%= r.SDev %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>Pol</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.Pol %>"><%= r.Pol %></td>
              <% }) %>
            </tr>
            <tr>
              <th>Res</th>
              <% mfarRows.forEach(r => { %>
                <td title="<%= r.Res %>"><%= r.Res %></td>
              <% }) %>
            </tr>
            <tr>
              <th>Issue</th>
              <% mfarRows.forEach(r => { %>
                <% const _issue = String(r.Issue || '').trim().toLowerCase(); const _sev = _issue.startsWith('okw') ? 'warn' : (_issue && _issue !== 'passed') ? 'danger' : 'ok'; %>
                <td class="<%= _sev === 'danger' ? 'cell-danger' : '' %>" title="<%= r.Issue %>"><span class="<%= _sev === 'danger' ? 'badge badge-danger' : (_sev === 'warn' ? 'badge badge-warn' : 'badge') %>"><%= r.Issue %></span></td>
              <% }) %>
            </tr>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>
  <section class="panel">
    <h2>mfitr</h2>
    <% if (typeof mfitrRows === 'undefined' || mfitrRows.length === 0) { %>
      <p>Nessun dato trovato nella sezione mfitr dei log caricati.</p>
    <% } else { %>
      <div class="table-scroll">
        <table class="table table-fit table-transposed sticky-header sticky-first-col table-mfitr">
          <tbody>
            <tr>
              <th>Cell</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.SC %>"><%= r.SC %></td>
              <% }) %>
            </tr>
            <tr>
              <th>Radio</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.FRU %>"><%= r.FRU %></td>
              <% }) %>
            </tr>
            <tr>
              <th>BOARD</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.BOARD %>"><%= r.BOARD %></td>
              <% }) %>
            </tr>
            <tr>
              <th>PUSCH</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.PUSCH %>"><%= r.PUSCH %></td>
              <% }) %>
            </tr>
            <tr>
              <th>PUCCH</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.PUCCH %>"><%= r.PUCCH %></td>
              <% }) %>
            </tr>
            <tr>
              <th>A</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.A %>"><span class="num"><%= r.A %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>B</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.B %>"><span class="num"><%= r.B %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>C</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.C %>"><span class="num"><%= r.C %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>D</th>
              <% mfitrRows.forEach(r => { %>
                <td title="<%= r.D %>"><span class="num"><%= r.D %></span></td>
              <% }) %>
            </tr>
            <tr>
              <th>DELTA</th>
              <% mfitrRows.forEach(r => { %>
                <% const mD = String(r.DELTA || '').match(/^[\s]*([+-]?[0-9]+(?:[.,][0-9]+)?)/); const vD = mD ? parseFloat(mD[1].replace(',', '.')) : NaN; const badD = (!Number.isNaN(vD) && vD > 3.9); %>
                <td class="<%= badD ? 'cell-danger' : '' %>" title="<%= r.DELTA %>"><span class="num <%= badD ? 'badge badge-danger' : '' %>"><%= r.DELTA %></span></td>
              <% }) %>
            </tr>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>
  
  </body>
  </html>
