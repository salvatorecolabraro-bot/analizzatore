<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gestione file</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header>
    <h1>Area Amministratore</h1>
    <nav>
      <a href="/" class="link-viewer">Viaualizzazione performance Nodi</a>
    </nav>
  </header>

  <main>
    <% if (msg) { %>
      <div class="alert"><%= msg %></div>
    <% } %>

    <section class="panel">
      <h2>Importa file (.txt, .log) â€” fino a 10000 alla volta</h2>
      <form action="/admin/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="files" multiple accept=".txt,.log" />
        <button class="btn" type="submit">Carica</button>
      </form>
    </section>

    <section class="panel">
      <h2>File presenti (<%= files.length %>)</h2>
      <% if (files.length === 0) { %>
        <p>Nessun file presente.</p>
      <% } else { %>
        <form action="/admin/delete" method="post">
          <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
            <label>
              <input type="checkbox" id="selectAll" />
              <span>Seleziona tutti</span>
            </label>
            <button class="btn danger" type="submit">Elimina selezionati</button>
          </div>
          <ul class="file-list">
            <% files.forEach(f => { %>
              <li>
                <label>
                  <input type="checkbox" name="selected" value="<%= f %>" />
                  <span><%= f %></span>
                </label>
                <a class="btn" href="/view/<%= encodeURIComponent(f) %>">Visualizza</a>
              </li>
            <% }) %>
          </ul>
        </form>
        <script>
          document.addEventListener('DOMContentLoaded', function(){
            var form = document.querySelector('form[action="/admin/delete"]');
            if (!form) return;
            var master = document.getElementById('selectAll');
            if (!master) return;
            function updateMaster(){
              var boxes = form.querySelectorAll('input[type="checkbox"][name="selected"]');
              var total = boxes.length;
              var checked = 0;
              boxes.forEach(function(cb){ if (cb.checked) checked++; });
              master.checked = checked === total && total > 0;
              master.indeterminate = checked > 0 && checked < total;
            }
            master.addEventListener('change', function(){
              var boxes = form.querySelectorAll('input[type="checkbox"][name="selected"]');
              boxes.forEach(function(cb){ cb.checked = master.checked; });
            });
            var boxes = form.querySelectorAll('input[type="checkbox"][name="selected"]');
            boxes.forEach(function(cb){ cb.addEventListener('change', updateMaster); });
          });
        </script>
      <% } %>
    </section>
  </main>
</body>
</html>
